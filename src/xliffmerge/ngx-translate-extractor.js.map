{"version":3,"file":"ngx-translate-extractor.js","sourceRoot":"","sources":["../../../../projects/xliffmerge/src/xliffmerge/ngx-translate-extractor.ts"],"names":[],"mappings":"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","sourcesContent":["import {ITranslationMessagesFile, ITransUnit, NORMALIZATION_FORMAT_NGXTRANSLATE} from '@ngx-i18nsupport/ngx-i18nsupport-lib';\nimport {FileUtil} from '../common/file-util';\nimport {isNullOrUndefined} from '../common/util';\nimport {NgxTranslateExtractionPattern} from './ngx-translate-extraction-pattern';\n/**\n * Created by roobm on 15.03.2017.\n * A tool for extracting messages in ngx-translate format.\n * Generates a json-file to be used with ngx-translate.\n */\n\n/**\n * The interface used for translations in ngx-translate.\n * A hash that contains either the translation or another hash.\n */\ninterface NgxTranslations {\n    [id: string]: NgxTranslations | string;\n}\n\n/**\n * internal,\n * a message with id (a dot-separated string).\n */\ninterface NgxMessage {\n    id: string; // dot separated name, e.g. \"myapp.service1.message1\"\n    message: string; // the message, placeholder are in {{n}} syntax, e.g. \"a test with value: {{0}}\n}\n\nexport class NgxTranslateExtractor {\n\n    public static DefaultExtractionPattern = '@@|ngx-translate';\n    private extractionPattern: NgxTranslateExtractionPattern;\n\n    /**\n     * Check, wether extractionPattern has valid syntax.\n     * @param extractionPatternString extractionPatternString\n     * @return null, if pattern is ok, string describing the error, if it is not ok.\n     */\n    public static checkPattern(extractionPatternString: string): string {\n        try {\n          if (new NgxTranslateExtractionPattern(extractionPatternString)) {\n              return null;\n          }\n        } catch (error) {\n            return error.message;\n        }\n        return null;\n    }\n\n    public static extract(messagesFile: ITranslationMessagesFile, extractionPattern: string, outputFile: string) {\n        new NgxTranslateExtractor(messagesFile, extractionPattern).extractTo(outputFile);\n    }\n\n    constructor(private messagesFile: ITranslationMessagesFile, extractionPatternString: string) {\n        this.extractionPattern = new NgxTranslateExtractionPattern(extractionPatternString);\n    }\n\n    /**\n     * Extact messages and write them to a file.\n     * @param outputFile outputFile\n     */\n    public extractTo(outputFile: string) {\n        const translations: NgxTranslations = this.toNgxTranslations(this.extract());\n        if (translations && Object.keys(translations).length > 0) {\n            FileUtil.replaceContent(outputFile, JSON.stringify(translations, null, 4), 'UTF-8');\n        } else {\n            if (FileUtil.exists(outputFile)) {\n                FileUtil.deleteFile(outputFile);\n            }\n        }\n    }\n\n    /**\n     *  Extract messages and convert them to ngx translations.\n     *  @return the translation objects.\n     */\n    private extract(): NgxMessage[] {\n        const result: NgxMessage[] = [];\n        this.messagesFile.forEachTransUnit((tu: ITransUnit) => {\n            const ngxId = this.ngxTranslateIdFromTU(tu);\n            if (ngxId) {\n                const messagetext = tu.targetContentNormalized().asDisplayString(NORMALIZATION_FORMAT_NGXTRANSLATE);\n                result.push({id: ngxId, message: messagetext});\n            }\n        });\n        return result;\n    }\n\n    /**\n     * Check, wether this tu should be extracted for ngx-translate usage, and return its id for ngx-translate.\n     * There are 2 possibilities:\n     * 1. description is set to \"ngx-translate\" and meaning contains the id.\n     * 2. id is explicitly set to a string.\n     * @param tu tu\n     * @return an ngx id or null, if this tu should not be extracted.\n     */\n    private ngxTranslateIdFromTU(tu: ITransUnit): string {\n        if (this.isExplicitlySetId(tu.id)) {\n            if (this.extractionPattern.isExplicitIdMatched(tu.id)) {\n                return tu.id;\n            } else {\n                return null;\n            }\n        }\n        const description = tu.description();\n        if (description && this.extractionPattern.isDescriptionMatched(description)) {\n            return tu.meaning();\n        }\n    }\n\n    /**\n     * Test, wether ID was explicitly set (via i18n=\"@myid).\n     * Just heuristic, an ID is explicitly, if it does not look like a generated one.\n     * @param id id\n     * @return wether ID was explicitly set (via i18n=\"@myid).\n     */\n    private isExplicitlySetId(id: string): boolean {\n        if (isNullOrUndefined(id)) {\n            return false;\n        }\n        // generated IDs are either decimal or sha1 hex\n        const reForGeneratedId = /^[0-9a-f]{11,}$/;\n        return !reForGeneratedId.test(id);\n    }\n\n    /**\n     * Convert list of relevant TUs to ngx translations object.\n     * @param msgList msgList\n     */\n    private toNgxTranslations(msgList: NgxMessage[]): NgxTranslations {\n        const translationObject: NgxTranslations = {};\n        msgList.forEach((msg: NgxMessage) => {\n            this.putInTranslationObject(translationObject, msg);\n        });\n        return translationObject;\n    }\n\n    /**\n     * Put a new messages into the translation data object.\n     * If you add, e.g. \"{id: 'myapp.example', message: 'test'}\",\n     * the translation object will then contain an object myapp that has property example:\n     * {myapp: {\n     *   example: 'test'\n     *   }}\n     * @param translationObject translationObject\n     * @param msg msg\n     */\n    private putInTranslationObject(translationObject: NgxTranslations, msg: NgxMessage) {\n        let firstPartOfId: string;\n        let restOfId: string;\n        const indexOfDot = msg.id.indexOf('.');\n        if (indexOfDot === 0 || indexOfDot === (msg.id.length - 1)) {\n            throw new Error('bad nxg-translate id \"' + msg.id + '\"');\n        }\n        if (indexOfDot < 0) {\n            firstPartOfId = msg.id;\n            restOfId = '';\n        } else {\n            firstPartOfId = msg.id.substring(0, indexOfDot);\n            restOfId = msg.id.substring(indexOfDot + 1);\n        }\n        let object = translationObject[firstPartOfId];\n        if (isNullOrUndefined(object)) {\n            if (restOfId === '') {\n                translationObject[firstPartOfId] = msg.message;\n                return;\n            }\n            object = {};\n            translationObject[firstPartOfId] = object;\n        } else {\n            if (restOfId === '') {\n                throw new Error('duplicate id praefix \"' + msg.id + '\"');\n            }\n        }\n        this.putInTranslationObject(<NgxTranslations> object, {id: restOfId, message: msg.message});\n    }\n}\n"]}